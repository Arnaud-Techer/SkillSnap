@page "/portfolio"
@using Shared.Models
@using Client.Components
@using Client.Models
@using Client.ViewModels
@using Client.Services
@inject PortfolioUserViewModel PortfolioUserViewModel
@inject SkillViewModel SkillViewModel
@inject ProjectViewModel ProjectViewModel
@inject StatisticsRefreshService StatisticsRefreshService
@inject AuthViewModel AuthViewModel
@inject IJSRuntime JSRuntime
@implements IDisposable

<PageTitle>Portfolio - SkillSnap</PageTitle>

<div class="portfolio-page">
    <PortfolioHeader 
        SearchQuery="@searchQuery"
        IsSearching="isSearching"
        OnSearchQueryChanged="HandleSearchQueryChange"
        OnSearchKeyDown="HandleSearchKeyDownWrapper"
        OnClearSearch="ClearSearch"
        OnAddPortfolio="OpenAddPortfolioModal"
        OnDeletePortfolio="OpenDeletePortfolioModal"
        OnShowAuthRequired="ShowAuthRequiredMessage" />

    <div class="portfolio-content">
        @if (PortfolioUserViewModel.ErrorMessage != null)
        {
            <div class="debug-message">
                <strong>Debug:</strong> ErrorMessage = "@PortfolioUserViewModel.ErrorMessage"
            </div>
        }
        
        @if (PortfolioUserViewModel.IsLoading)
        {
            <div class="loading-container">
                <div class="loading-spinner"></div>
                <span class="loading-text">Loading portfolios...</span>
            </div>
        }
        else if (!string.IsNullOrEmpty(PortfolioUserViewModel.ErrorMessage))
        {
            <div class="error-container">
                <div class="error-icon">
                    <svg class="error-icon-svg" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                    </svg>
                </div>
                <h3 class="error-title">Error Loading Portfolios</h3>
                <p class="error-message">@PortfolioUserViewModel.ErrorMessage</p>
                <button @onclick="ReloadPortfolios" class="btn-danger">
                    Try Again
                </button>
            </div>
        }
        else if (GetDisplayedPortfolios() != null && GetDisplayedPortfolios().Any())
        {
            <PortfolioGrid 
                Portfolios="GetDisplayedPortfolios()"
                IsShowingSearchResults="IsShowingSearchResults()"
                SearchQuery="searchQuery"
                OnViewSkills="ViewFullSkills"
                OnViewProjects="ViewFullProjects"
                OnContact="ContactDeveloper"
                OnClearSearch="ClearSearch" />
        }
        else
        {
            <EmptyState 
                IsSearchResults="IsShowingSearchResults()"
                SearchQuery="searchQuery"
                OnClearSearch="ClearSearch"
                OnAddPortfolio="OpenAddPortfolioModal"
                OnShowAuthRequired="ShowAuthRequiredMessage" />
        }
    </div>
    <PortfolioModals 
        SkillViewModel="SkillViewModel"
        ProjectViewModel="ProjectViewModel"
        ShowSkillsModal="showSkillsModal"
        ShowProjectsModal="showProjectsModal"
        ShowAddPortfolioModal="showAddPortfolioModal"
        ShowDeletePortfolioModal="showDeletePortfolioModal"
        ShowAddProjectModal="showAddProjectModal"
        ShowAddSkillModal="showAddSkillModal"
        ShowAddProjectToExistingModal="showAddProjectToExistingModal"
        ShowAddSkillToExistingModal="showAddSkillToExistingModal"
        ShowEditSkillModal="showEditSkillModal"
        ShowEditProjectModal="showEditProjectModal"
        PendingProjects="pendingProjects"
        PendingSkills="pendingSkills"
        Portfolios="PortfolioUserViewModel.PortfolioUsers"
        SelectedSkillForEdit="selectedSkillForEdit"
        SelectedProjectForEdit="selectedProjectForEdit"
        OnCloseSkillsModal="CloseSkillsModal"
        OnCloseProjectsModal="CloseProjectsModal"
        OnCloseAddPortfolioModal="CloseAddPortfolioModal"
        OnCloseDeletePortfolioModal="CloseDeletePortfolioModal"
        OnCloseAddProjectModal="CloseAddProjectModal"
        OnCloseAddSkillModal="CloseAddSkillModal"
        OnCloseAddProjectToExistingModal="CloseAddProjectToExistingModal"
        OnCloseAddSkillToExistingModal="CloseAddSkillToExistingModal"
        OnCloseEditSkillModal="CloseEditSkillModal"
        OnCloseEditProjectModal="CloseEditProjectModal"
        OnPortfolioSubmit="HandlePortfolioSubmit"
        OnProjectSubmit="HandleProjectSubmit"
        OnSkillSubmit="HandleSkillSubmit"
        OnAddProject="OpenAddProjectModal"
        OnAddSkill="OpenAddSkillToExistingModal"
        OnAddProjectToExisting="HandleAddProjectToExisting"
        OnAddSkillToExisting="HandleAddSkillToExisting"
        OnEditSkill="HandleEditSkill"
        OnEditProject="HandleEditProject"
        OnDeleteSkill="HandleDeleteSkill"
        OnDeleteProject="HandleDeleteProject"
        OnDeletePortfolio="HandleDeletePortfolio" />
</div>

@code {
    private bool showSkillsModal = false;
    private bool showProjectsModal = false;
    private bool showAddPortfolioModal = false;
    private bool showDeletePortfolioModal = false;
    private bool showAddProjectModal = false;
    private bool showAddSkillModal = false;
    private bool showAddProjectToExistingModal = false;
    private bool showAddSkillToExistingModal = false;
    private bool showEditSkillModal = false;
    private bool showEditProjectModal = false;
    private int selectedUserId = 0;
    private bool isAddingProject = false;
    private bool isAddingSkill = false;
    
    // Selected items for editing
    private Skill? selectedSkillForEdit = null;
    private Project? selectedProjectForEdit = null;

    // Search functionality
    private string searchQuery = string.Empty;
    private bool isSearching = false;
    private IEnumerable<PortfolioUserSummary>? searchResults = null;
    private System.Threading.Timer? searchTimer;
    private string previousSearchQuery = string.Empty;


    // Portfolio creation form
    private List<Project> pendingProjects = new();
    private List<Skill> pendingSkills = new();


    protected override async Task OnInitializedAsync()
    {
        await AuthViewModel.CheckAuthenticationStatusAsync();
        await PortfolioUserViewModel.LoadPortfolioUsersAsync();
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        // Check if search query has changed and trigger debounced search
        if (searchQuery != previousSearchQuery)
        {
            previousSearchQuery = searchQuery;
            await HandleSearchQueryChange(searchQuery);
        }
    }




    // Modal control methods
    private void OpenAddPortfolioModal()
    {
        showAddPortfolioModal = true;
        StateHasChanged();
    }

    private void CloseAddPortfolioModal()
    {
        showAddPortfolioModal = false;
        ResetPortfolioForm();
        StateHasChanged();
    }

    private void OpenDeletePortfolioModal()
    {
        showDeletePortfolioModal = true;
        StateHasChanged();
    }

    private void CloseDeletePortfolioModal()
    {
        showDeletePortfolioModal = false;
        StateHasChanged();
    }

    private void OpenAddProjectModal()
    {
        showAddProjectModal = true;
        StateHasChanged();
    }

    private void CloseAddProjectModal()
    {
        showAddProjectModal = false;
        StateHasChanged();
    }

    private void OpenAddSkillModal()
    {
        showAddSkillModal = true;
        StateHasChanged();
    }

    private void CloseAddSkillModal()
    {
        showAddSkillModal = false;
        StateHasChanged();
    }

    // Modal control methods for existing portfolios
    private void OpenAddProjectToExistingModal()
    {
        if (!AuthViewModel.IsAuthenticated)
        {
            ShowAuthRequiredMessage();
            return;
        }

        showAddProjectToExistingModal = true;
        StateHasChanged();
    }

    private void CloseAddProjectToExistingModal()
    {
        showAddProjectToExistingModal = false;
        StateHasChanged();
    }

    private void OpenAddSkillToExistingModal()
    {
        Console.WriteLine("[DEBUG] PortfolioUsers.OpenAddSkillToExistingModal called");
        Console.WriteLine($"[DEBUG] AuthViewModel.IsAuthenticated: {AuthViewModel.IsAuthenticated}");
        
        if (!AuthViewModel.IsAuthenticated)
        {
            Console.WriteLine("[DEBUG] User not authenticated, showing auth required message");
            ShowAuthRequiredMessage();
            return;
        }

        Console.WriteLine("[DEBUG] Setting showAddSkillToExistingModal to true");
        showAddSkillToExistingModal = true;
        StateHasChanged();
        Console.WriteLine("[DEBUG] StateHasChanged called");
    }

    private void CloseAddSkillToExistingModal()
    {
        showAddSkillToExistingModal = false;
        StateHasChanged();
    }

    private void ResetPortfolioForm()
    {
        pendingProjects.Clear();
        pendingSkills.Clear();
    }

    private void HandleProjectSubmit((string title, string description, string imageUrl) formData)
    {
        if (!string.IsNullOrWhiteSpace(formData.title) && !string.IsNullOrWhiteSpace(formData.description))
        {
            var project = new Project
            {
                Title = formData.title,
                Description = formData.description,
                ImageUrl = string.IsNullOrWhiteSpace(formData.imageUrl) ? null : formData.imageUrl
            };
            
            pendingProjects.Add(project);
            CloseAddProjectModal();
            StateHasChanged();
        }
    }

    private void HandleSkillSubmit((string name, string level) formData)
    {
        if (!string.IsNullOrWhiteSpace(formData.name) && !string.IsNullOrWhiteSpace(formData.level))
        {
            var skill = new Skill
            {
                Name = formData.name,
                Level = formData.level
            };
            
            pendingSkills.Add(skill);
            CloseAddSkillModal();
            StateHasChanged();
        }
    }

    // Handlers for adding to existing portfolios
    private async Task HandleAddProjectToExisting((string title, string description, string imageUrl) formData)
    {
        // Prevent multiple simultaneous submissions
        if (isAddingProject || string.IsNullOrWhiteSpace(formData.title) || string.IsNullOrWhiteSpace(formData.description) || selectedUserId <= 0)
        {
            return;
        }

        isAddingProject = true;
        
        try
        {
            var project = new Project
            {
                Title = formData.title,
                Description = formData.description,
                ImageUrl = string.IsNullOrWhiteSpace(formData.imageUrl) ? null : formData.imageUrl,
                PortfolioUserId = selectedUserId
            };

            await ProjectViewModel.CreateProjectAsync(project);
            
            // Close modal first to prevent re-rendering issues
            CloseAddProjectToExistingModal();
            
            // Refresh the projects for this user
            await ProjectViewModel.LoadProjectsByUserAsync(selectedUserId);
            
            // Refresh the main portfolio list to update counters
            await PortfolioUserViewModel.LoadPortfolioUsersAsync();
            
            // Refresh navigation statistics
            StatisticsRefreshService.NotifyStatisticsChanged();
        }
        catch (UnauthorizedAccessException ex)
        {
            // Handle unauthorized access - could show a toast notification or error message
            // For now, we'll just log the error and let the user know they need to sign in
            Console.WriteLine($"Unauthorized access: {ex.Message}");
        }
        catch (Exception)
        {
        }
        finally
        {
            isAddingProject = false;
        }
    }

    private async Task HandleAddSkillToExisting((string name, string level) formData)
    {
        Console.WriteLine($"[DEBUG] HandleAddSkillToExisting called with: name='{formData.name}', level='{formData.level}', selectedUserId={selectedUserId}");
        
        // Prevent multiple simultaneous submissions
        if (isAddingSkill || string.IsNullOrWhiteSpace(formData.name) || string.IsNullOrWhiteSpace(formData.level) || selectedUserId <= 0)
        {
            Console.WriteLine($"[DEBUG] Early return - isAddingSkill={isAddingSkill}, name empty={string.IsNullOrWhiteSpace(formData.name)}, level empty={string.IsNullOrWhiteSpace(formData.level)}, selectedUserId={selectedUserId}");
            return;
        }

        isAddingSkill = true;
        Console.WriteLine("[DEBUG] Starting skill creation process...");
        
        try
        {
            var skill = new Skill
            {
                Name = formData.name,
                Level = formData.level,
                PortfolioUserId = selectedUserId
            };

            Console.WriteLine($"[DEBUG] Created skill object: {skill.Name}, {skill.Level}, PortfolioUserId={skill.PortfolioUserId}");
            Console.WriteLine("[DEBUG] Calling SkillViewModel.CreateSkillAsync...");
            
            var result = await SkillViewModel.CreateSkillAsync(skill);
            Console.WriteLine($"[DEBUG] SkillViewModel.CreateSkillAsync returned: {result != null}");
            
            // Close modal first to prevent re-rendering issues
            CloseAddSkillToExistingModal();
            
            // Refresh the skills for this user
            await SkillViewModel.LoadSkillsByUserAsync(selectedUserId);
            
            // Refresh the main portfolio list to update counters
            await PortfolioUserViewModel.LoadPortfolioUsersAsync();
            
            // Refresh navigation statistics
            StatisticsRefreshService.NotifyStatisticsChanged();
        }
        catch (UnauthorizedAccessException ex)
        {
            // Handle unauthorized access - could show a toast notification or error message
            // For now, we'll just log the error and let the user know they need to sign in
            Console.WriteLine($"Unauthorized access: {ex.Message}");
        }
        catch (Exception)
        {
        }
        finally
        {
            isAddingSkill = false;
        }
    }

    private async Task HandlePortfolioSubmit((string name, string bio, string imageUrl) formData)
    {
        // Validate form
        if (string.IsNullOrWhiteSpace(formData.name) || 
            string.IsNullOrWhiteSpace(formData.bio) || 
            formData.bio.Length < 20)
        {
            return; // Form validation will handle this
        }

        try
        {
            // Create portfolio user
            var portfolioUser = new PortfolioUser
            {
                Name = formData.name,
                Bio = formData.bio,
                ProfileImageUrl = string.IsNullOrWhiteSpace(formData.imageUrl) ? null : formData.imageUrl
            };

            var createdUser = await PortfolioUserViewModel.CreatePortfolioUserAsync(portfolioUser);
            
            if (createdUser != null)
            {
                // Add projects
                foreach (var project in pendingProjects)
                {
                    project.PortfolioUserId = createdUser.Id;
                    await ProjectViewModel.CreateProjectAsync(project);
                }

                // Add skills
                foreach (var skill in pendingSkills)
                {
                    skill.PortfolioUserId = createdUser.Id;
                    await SkillViewModel.CreateSkillAsync(skill);
                }

                // Close modal and reset form
                CloseAddPortfolioModal();
                
                // Refresh the portfolio list
                await PortfolioUserViewModel.LoadPortfolioUsersAsync();
                
                // Refresh navigation statistics
                StatisticsRefreshService.NotifyStatisticsChanged();
                
                StateHasChanged();
            }
        }
        catch (UnauthorizedAccessException ex)
        {
            // Handle unauthorized access - could show a toast notification or error message
            // For now, we'll just log the error and let the user know they need to sign in
            Console.WriteLine($"Unauthorized access: {ex.Message}");
        }
        catch (Exception)
        {
            // You could add error handling here
        }
    }

    private async Task ViewFullSkills(int userId)
    {
        selectedUserId = userId;
        showSkillsModal = true;
        await SkillViewModel.LoadSkillsByUserAsync(userId);
        StateHasChanged();
    }

    private async Task ViewFullProjects(int userId)
    {
        selectedUserId = userId;
        showProjectsModal = true;
        await ProjectViewModel.LoadProjectsByUserAsync(userId);
        StateHasChanged();
    }

    private void ContactDeveloper(PortfolioUserSummary user)
    {
        // TODO: Implement contact functionality
        // This could open a contact form, email client, or redirect to a contact page
    }

    private void CloseSkillsModal()
    {
        showSkillsModal = false;
        SkillViewModel.ClearError();
        StateHasChanged();
    }

    private void CloseProjectsModal()
    {
        showProjectsModal = false;
        ProjectViewModel.ClearError();
        StateHasChanged();
    }

    private async Task ReloadPortfolios()
    {
        PortfolioUserViewModel.ClearError();
        await PortfolioUserViewModel.LoadPortfolioUsersAsync();
        StateHasChanged();
    }



    private async Task HandleDeletePortfolio(int portfolioId)
    {
        try
        {
            // Delete the portfolio using the service
            var success = await PortfolioUserViewModel.DeletePortfolioUserAsync(portfolioId);
            
            if (success)
            {
                // Close the modal
                CloseDeletePortfolioModal();
                
                // Refresh the portfolio list
                await PortfolioUserViewModel.LoadPortfolioUsersAsync();
                
                // Refresh navigation statistics
                StatisticsRefreshService.NotifyStatisticsChanged();
                
            }
            else
            {
                // You could add error handling here, like showing a toast notification
            }
        }
        catch (Exception)
        {
            // You could add error handling here, like showing a toast notification
        }
    }

    // Edit Skill Modal Methods
    private void OpenEditSkillModal(Skill skill)
    {
        if (!AuthViewModel.IsAuthenticated)
        {
            ShowAuthRequiredMessage();
            return;
        }

        selectedSkillForEdit = skill;
        showEditSkillModal = true;
        StateHasChanged();
    }

    private void CloseEditSkillModal()
    {
        selectedSkillForEdit = null;
        showEditSkillModal = false;
        StateHasChanged();
    }

    private async Task HandleEditSkill(Skill updatedSkill)
    {
        try
        {
            var success = await SkillViewModel.UpdateSkillAsync(updatedSkill.Id, updatedSkill);
            
            if (success)
            {
                CloseEditSkillModal();
                
                // Refresh the skills for this user
                await SkillViewModel.LoadSkillsByUserAsync(selectedUserId);
                
                // Refresh the main portfolio list to update counters
                await PortfolioUserViewModel.LoadPortfolioUsersAsync();
                
                // Refresh navigation statistics
                StatisticsRefreshService.NotifyStatisticsChanged();
                
            }
            else
            {
            }
        }
        catch (Exception)
        {
        }
    }

    // Edit Project Modal Methods
    private void OpenEditProjectModal(Project project)
    {
        if (!AuthViewModel.IsAuthenticated)
        {
            ShowAuthRequiredMessage();
            return;
        }

        selectedProjectForEdit = project;
        showEditProjectModal = true;
        StateHasChanged();
    }

    private void CloseEditProjectModal()
    {
        selectedProjectForEdit = null;
        showEditProjectModal = false;
        StateHasChanged();
    }

    private async Task HandleEditProject(Project updatedProject)
    {
        try
        {
            var success = await ProjectViewModel.UpdateProjectAsync(updatedProject.Id, updatedProject);
            
            if (success)
            {
                CloseEditProjectModal();
                
                // Refresh the projects for this user
                await ProjectViewModel.LoadProjectsByUserAsync(selectedUserId);
                
                // Refresh the main portfolio list to update counters
                await PortfolioUserViewModel.LoadPortfolioUsersAsync();
                
                // Refresh navigation statistics
                StatisticsRefreshService.NotifyStatisticsChanged();
                
            }
            else
            {
            }
        }
        catch (Exception)
        {
        }
    }

    // Delete Skill Method
    private async Task HandleDeleteSkill(Skill skill)
    {
        if (!AuthViewModel.IsAuthenticated)
        {
            ShowAuthRequiredMessage();
            return;
        }
        
        try
        {
            var success = await SkillViewModel.DeleteSkillAsync(skill.Id);
            
            if (success)
            {
                // Refresh the skills for this user
                await SkillViewModel.LoadSkillsByUserAsync(selectedUserId);
                
                // Refresh the main portfolio list to update counters
                await PortfolioUserViewModel.LoadPortfolioUsersAsync();
                
                // Refresh navigation statistics
                StatisticsRefreshService.NotifyStatisticsChanged();
                
            }
            else
            {
            }
        }
        catch (Exception)
        {
        }
    }

    // Delete Project Method
    private async Task HandleDeleteProject(Project project)
    {
        if (!AuthViewModel.IsAuthenticated)
        {
            ShowAuthRequiredMessage();
            return;
        }
        
        try
        {
            var success = await ProjectViewModel.DeleteProjectAsync(project.Id);
            
            if (success)
            {
                // Refresh the projects for this user
                await ProjectViewModel.LoadProjectsByUserAsync(selectedUserId);
                
                // Refresh the main portfolio list to update counters
                await PortfolioUserViewModel.LoadPortfolioUsersAsync();
                
                // Refresh navigation statistics
                StatisticsRefreshService.NotifyStatisticsChanged();
                
            }
            else
            {
            }
        }
        catch (Exception)
        {
        }
    }


    // Get the portfolios to display (search results or all portfolios)
    private IEnumerable<PortfolioUserSummary> GetDisplayedPortfolios()
    {
        if (!string.IsNullOrWhiteSpace(searchQuery) && searchResults != null)
        {
            return searchResults;
        }
        return PortfolioUserViewModel.PortfolioUsers ?? Enumerable.Empty<PortfolioUserSummary>();
    }

    // Check if we're currently showing search results
    private bool IsShowingSearchResults()
    {
        return !string.IsNullOrWhiteSpace(searchQuery) && searchResults != null;
    }

    // Search Methods
    private async Task HandleSearchQueryChange(string newSearchQuery)
    {
        // Update the search query
        searchQuery = newSearchQuery;
        
        // Clear existing timer
        searchTimer?.Dispose();

        if (string.IsNullOrWhiteSpace(searchQuery))
        {
            await ClearSearch();
            return;
        }

        // Set up debounced search (500ms delay)
        searchTimer = new System.Threading.Timer(async _ =>
        {
            await InvokeAsync(async () =>
            {
                await PerformSearch();
            });
        }, null, 500, System.Threading.Timeout.Infinite);
    }

    private async Task HandleSearchKeyDownWrapper()
    {
        // Cancel timer and search immediately
        searchTimer?.Dispose();
        await PerformSearch();
    }

    private async Task HandleSearchKeyDown(KeyboardEventArgs e)
    {
        if (e.Key == "Enter")
        {
            // Cancel timer and search immediately
            searchTimer?.Dispose();
            await PerformSearch();
        }
    }

    private async Task PerformSearch()
    {
        if (string.IsNullOrWhiteSpace(searchQuery))
        {
            await ClearSearch();
            return;
        }

        isSearching = true;
        try
        {
            // Set the SearchName property and use the existing search functionality
            PortfolioUserViewModel.SearchName = searchQuery.Trim();
            await PortfolioUserViewModel.SearchPortfolioUsersAsync();
            searchResults = PortfolioUserViewModel.PortfolioUsers;
            
        }
        catch (Exception)
        {
            searchResults = Enumerable.Empty<PortfolioUserSummary>();
        }
        finally
        {
            isSearching = false;
            StateHasChanged();
        }
    }

    // Clear search method for the clear button
    private async Task ClearSearch()
    {
        Console.WriteLine($"[DEBUG] PortfolioUsers.ClearSearch called - Current searchQuery: '{searchQuery}'");
        searchQuery = string.Empty;
        searchResults = null;
        isSearching = false;
        previousSearchQuery = string.Empty;
        Console.WriteLine($"[DEBUG] PortfolioUsers.ClearSearch - searchQuery set to: '{searchQuery}'");

        // Clear the SearchName property
        PortfolioUserViewModel.SearchName = null;

        // Reload all portfolios
        await PortfolioUserViewModel.LoadPortfolioUsersAsync();
        StateHasChanged();
        Console.WriteLine($"[DEBUG] PortfolioUsers.ClearSearch completed - Final searchQuery: '{searchQuery}'");
    }

    private void ShowAuthRequiredMessage()
    {
        // Instead of using JavaScript alert, we could show a toast notification or modal
        // For now, we'll just log the message
        Console.WriteLine("Please sign in to create or manage portfolios. You need to be logged in to create new portfolios, delete existing portfolios, and add projects and skills. Click 'Sign In' in the navigation menu to get started!");
    }

    public void Dispose()
    {
        searchTimer?.Dispose();
    }
}
