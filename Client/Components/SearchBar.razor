@using Client.ViewModels
@inject AuthViewModel AuthViewModel

<div class="search-bar-container">
    <div class="search-container">
        <div class="search-icon">
            @if (IsSearching)
            {
                <svg class="search-spinner" fill="none" viewBox="0 0 24 24">
                    <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                    <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                </svg>
            }
            else
            {
                <svg class="search-icon-svg" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
                </svg>
            }
        </div>
        <input type="text" 
               @bind="SearchQuery" 
               @onkeydown="HandleSearchKeyDown"
               @oninput="HandleSearchInput"
               placeholder="Search portfolios by name..." 
               disabled="@IsSearching"
               class="search-input" />
        @if (!string.IsNullOrWhiteSpace(SearchQuery))
        {
            <button @onclick="ClearSearch" class="search-clear">
                <svg class="search-clear-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                </svg>
            </button>
        }
    </div>
</div>

@code {
    private string _searchQuery = string.Empty;
    
    [Parameter] 
    public string SearchQuery 
    { 
        get => _searchQuery;
        set 
        {
            Console.WriteLine($"[DEBUG] SearchBar.SearchQuery setter - Old: '{_searchQuery}', New: '{value}'");
            _searchQuery = value;
        }
    }
    
    [Parameter] public bool IsSearching { get; set; } = false;
    [Parameter] public EventCallback<string> OnSearchQueryChanged { get; set; }
    [Parameter] public EventCallback OnSearchKeyDown { get; set; }
    [Parameter] public EventCallback OnClearSearch { get; set; }

    private async Task HandleSearchKeyDown(KeyboardEventArgs e)
    {
        if (e.Key == "Enter")
        {
            await OnSearchKeyDown.InvokeAsync();
        }
    }

    private async Task HandleSearchInput(ChangeEventArgs e)
    {
        var newValue = e.Value?.ToString() ?? string.Empty;
        Console.WriteLine($"[DEBUG] SearchBar.HandleSearchInput - Old value: '{SearchQuery}', New value: '{newValue}'");
        SearchQuery = newValue;
        Console.WriteLine($"[DEBUG] SearchBar.HandleSearchInput - SearchQuery after assignment: '{SearchQuery}'");
        await OnSearchQueryChanged.InvokeAsync(SearchQuery);
        Console.WriteLine($"[DEBUG] SearchBar.HandleSearchInput - OnSearchQueryChanged invoked with: '{SearchQuery}'");
    }

    private async Task ClearSearch()
    {
        Console.WriteLine($"[DEBUG] SearchBar.ClearSearch called - Current SearchQuery: '{SearchQuery}'");
        await OnClearSearch.InvokeAsync();
        Console.WriteLine($"[DEBUG] SearchBar.ClearSearch completed - SearchQuery after clear: '{SearchQuery}'");
    }
}
