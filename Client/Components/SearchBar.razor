@using Client.ViewModels
@inject AuthViewModel AuthViewModel

<div class="search-bar-container">
    <div class="search-container">
        <div class="search-icon">
            @if (IsSearching)
            {
                <span class="search-spinner">‚è≥</span>
            }
            else
            {
                <span class="search-icon-svg">üîç</span>
            }
        </div>
        <input type="text" 
               @bind="SearchQuery" 
               @onkeydown="HandleSearchKeyDown"
               @oninput="HandleSearchInput"
               placeholder="Search portfolios by name..." 
               disabled="@IsSearching"
               class="search-input" />
        @if (!string.IsNullOrWhiteSpace(SearchQuery))
        {
            <button @onclick="ClearSearch" class="search-clear">
                <span class="search-clear-icon">‚úï</span>
            </button>
        }
    </div>
</div>

@code {
    private string _searchQuery = string.Empty;
    
    [Parameter] 
    public string SearchQuery 
    { 
        get => _searchQuery;
        set 
        {
            Console.WriteLine($"[DEBUG] SearchBar.SearchQuery setter - Old: '{_searchQuery}', New: '{value}'");
            _searchQuery = value;
        }
    }
    
    [Parameter] public bool IsSearching { get; set; } = false;
    [Parameter] public EventCallback<string> OnSearchQueryChanged { get; set; }
    [Parameter] public EventCallback OnSearchKeyDown { get; set; }
    [Parameter] public EventCallback OnClearSearch { get; set; }

    private async Task HandleSearchKeyDown(KeyboardEventArgs e)
    {
        if (e.Key == "Enter")
        {
            await OnSearchKeyDown.InvokeAsync();
        }
    }

    private async Task HandleSearchInput(ChangeEventArgs e)
    {
        var newValue = e.Value?.ToString() ?? string.Empty;
        Console.WriteLine($"[DEBUG] SearchBar.HandleSearchInput - Old value: '{SearchQuery}', New value: '{newValue}'");
        SearchQuery = newValue;
        Console.WriteLine($"[DEBUG] SearchBar.HandleSearchInput - SearchQuery after assignment: '{SearchQuery}'");
        await OnSearchQueryChanged.InvokeAsync(SearchQuery);
        Console.WriteLine($"[DEBUG] SearchBar.HandleSearchInput - OnSearchQueryChanged invoked with: '{SearchQuery}'");
    }

    private async Task ClearSearch()
    {
        Console.WriteLine($"[DEBUG] SearchBar.ClearSearch called - Current SearchQuery: '{SearchQuery}'");
        await OnClearSearch.InvokeAsync();
        Console.WriteLine($"[DEBUG] SearchBar.ClearSearch completed - SearchQuery after clear: '{SearchQuery}'");
    }
}
