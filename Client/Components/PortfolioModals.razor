@using Shared.Models
@using Client.Models
@using Client.ViewModels
@using Client.Components

<!-- Skills Modal -->
@if (ShowSkillsModal)
{
    <div class="modal-backdrop" @onclick="OnCloseSkillsModal">
        <div class="modal-content" @onclick:stopPropagation="true">
            <div class="modal-header skills-header">
                <div class="modal-header-content">
                    <h3 class="modal-title">
                        <span class="modal-title-icon">üí°</span>
                        Skills & Expertise
                    </h3>
                    <button @onclick="OnCloseSkillsModal" class="modal-close-button">
                        <span class="modal-close-icon">‚úï</span>
                    </button>
                </div>
            </div>
            
            <div class="modal-body">
                @if (SkillViewModel.IsLoading)
                {
                    <div class="modal-loading">
                        <div class="modal-loading-spinner"></div>
                        <span class="modal-loading-text">Loading skills...</span>
                    </div>
                }
                else
                {
                    <SkillTags Skills="SkillViewModel.Skills?.ToList()" 
                               OnAddSkill="OnAddSkill"
                               OnEditSkill="OnEditSkill"
                               OnDeleteSkill="OnDeleteSkill" />
                }
            </div>
        </div>
    </div>
}

<!-- Projects Modal -->
@if (ShowProjectsModal)
{
    <div class="modal-backdrop" @onclick="OnCloseProjectsModal">
        <div class="modal-content projects-modal" @onclick:stopPropagation="true">
            <div class="modal-header projects-header">
                <div class="modal-header-content">
                    <h3 class="modal-title">
                        <span class="modal-title-icon">üìÅ</span>
                        Featured Projects
                    </h3>
                    <button @onclick="OnCloseProjectsModal" class="modal-close-button">
                        <span class="modal-close-icon">‚úï</span>
                    </button>
                </div>
            </div>
            
            <div class="modal-body">
                @if (ProjectViewModel.IsLoading)
                {
                    <div class="modal-loading">
                        <div class="modal-loading-spinner projects-spinner"></div>
                        <span class="modal-loading-text">Loading projects...</span>
                    </div>
                }
                else
                {
                    <ProjectList Projects="ProjectViewModel.Projects?.ToList()" 
                                 OnAddProject="HandleAddProjectToExisting"
                                 OnEditProject="OnEditProject"
                                 OnDeleteProject="OnDeleteProject" />
                }
            </div>
        </div>
    </div>
}

<!-- Add Portfolio Modal -->
@if (ShowAddPortfolioModal)
{
    <AddPortfolioModal 
        PendingProjects="PendingProjects"
        PendingSkills="PendingSkills"
        OnClose="OnCloseAddPortfolioModal"
        OnSubmit="OnPortfolioSubmit"
        OnAddProject="OnAddProject"
        OnAddSkill="OnAddSkill" />
}

<!-- Delete Portfolio Modal -->
@if (ShowDeletePortfolioModal)
{
    <DeletePortfolioModal 
        ShowModal="ShowDeletePortfolioModal"
        Portfolios="Portfolios"
        OnClose="OnCloseDeletePortfolioModal"
        OnDelete="OnDeletePortfolio" />
}

<!-- Add Project Modal -->
@if (ShowAddProjectModal)
{
    <AddProjectModal 
        OnClose="OnCloseAddProjectModal"
        OnSubmit="OnProjectSubmit" />
}

<!-- Add Skill Modal -->
@if (ShowAddSkillModal)
{
    <AddSkillModal 
        OnClose="OnCloseAddSkillModal"
        OnSubmit="OnSkillSubmit" />
}

<!-- Add Project to Existing Portfolio Modal -->
@if (ShowAddProjectToExistingModal)
{
    <AddProjectModal 
        OnClose="OnCloseAddProjectToExistingModal"
        OnSubmit="OnAddProjectToExisting" />
}

<!-- Add Skill to Existing Portfolio Modal -->
@if (ShowAddSkillToExistingModal)
{
    <AddSkillModal 
        OnClose="OnCloseAddSkillToExistingModal"
        OnSubmit="HandleAddSkillToExistingWrapper" />
}

<!-- Edit Skill Modal -->
@if (ShowEditSkillModal)
{
    <EditSkillModal 
        ShowModal="ShowEditSkillModal"
        SkillToEdit="SelectedSkillForEdit"
        OnClose="OnCloseEditSkillModal"
        OnSubmit="OnEditSkill" />
}

<!-- Edit Project Modal -->
@if (ShowEditProjectModal)
{
    <EditProjectModal 
        ShowModal="ShowEditProjectModal"
        ProjectToEdit="SelectedProjectForEdit"
        OnClose="OnCloseEditProjectModal"
        OnSubmit="OnEditProject" />
}

@code {
    [Parameter] public SkillViewModel SkillViewModel { get; set; } = null!;
    [Parameter] public ProjectViewModel ProjectViewModel { get; set; } = null!;
    
    // Modal visibility states
    [Parameter] public bool ShowSkillsModal { get; set; } = false;
    [Parameter] public bool ShowProjectsModal { get; set; } = false;
    [Parameter] public bool ShowAddPortfolioModal { get; set; } = false;
    [Parameter] public bool ShowDeletePortfolioModal { get; set; } = false;
    [Parameter] public bool ShowAddProjectModal { get; set; } = false;
    [Parameter] public bool ShowAddSkillModal { get; set; } = false;
    [Parameter] public bool ShowAddProjectToExistingModal { get; set; } = false;
    [Parameter] public bool ShowAddSkillToExistingModal { get; set; } = false;
    [Parameter] public bool ShowEditSkillModal { get; set; } = false;
    [Parameter] public bool ShowEditProjectModal { get; set; } = false;
    
    // Data parameters
    [Parameter] public List<Project> PendingProjects { get; set; } = new();
    [Parameter] public List<Skill> PendingSkills { get; set; } = new();
    [Parameter] public IEnumerable<PortfolioUserSummary>? Portfolios { get; set; }
    [Parameter] public Skill? SelectedSkillForEdit { get; set; }
    [Parameter] public Project? SelectedProjectForEdit { get; set; }
    
    // Event callbacks
    [Parameter] public EventCallback OnCloseSkillsModal { get; set; }
    [Parameter] public EventCallback OnCloseProjectsModal { get; set; }
    [Parameter] public EventCallback OnCloseAddPortfolioModal { get; set; }
    [Parameter] public EventCallback OnCloseDeletePortfolioModal { get; set; }
    [Parameter] public EventCallback OnCloseAddProjectModal { get; set; }
    [Parameter] public EventCallback OnCloseAddSkillModal { get; set; }
    [Parameter] public EventCallback OnCloseAddProjectToExistingModal { get; set; }
    [Parameter] public EventCallback OnCloseAddSkillToExistingModal { get; set; }
    [Parameter] public EventCallback OnCloseEditSkillModal { get; set; }
    [Parameter] public EventCallback OnCloseEditProjectModal { get; set; }
    
    [Parameter] public EventCallback<(string name, string bio, string imageUrl)> OnPortfolioSubmit { get; set; }
    [Parameter] public EventCallback<(string title, string description, string imageUrl)> OnProjectSubmit { get; set; }
    [Parameter] public EventCallback<(string name, string level)> OnSkillSubmit { get; set; }
    [Parameter] public EventCallback OnAddProject { get; set; }
    [Parameter] public EventCallback OnAddSkill { get; set; }
    [Parameter] public EventCallback<(string title, string description, string imageUrl)> OnAddProjectToExisting { get; set; }
    [Parameter] public EventCallback<(string name, string level)> OnAddSkillToExisting { get; set; }
    
    private async Task HandleAddSkillToExistingWrapper((string name, string level) formData)
    {
        await OnAddSkillToExisting.InvokeAsync(formData);
    }
    
    protected override void OnParametersSet()
    {
        base.OnParametersSet();
    }
    [Parameter] public EventCallback<Skill> OnEditSkill { get; set; }
    [Parameter] public EventCallback<Project> OnEditProject { get; set; }
    [Parameter] public EventCallback<Skill> OnDeleteSkill { get; set; }
    [Parameter] public EventCallback<Project> OnDeleteProject { get; set; }
    [Parameter] public EventCallback<int> OnDeletePortfolio { get; set; }


    private async Task HandleAddProjectToExisting()
    {
        // Open the add project modal
        await OnAddProject.InvokeAsync();
    }
}
